{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "13b42640",
   "metadata": {},
   "source": [
    "# Final Project - Part 2: PostgreSQL Database Operations\n",
    "\n",
    "## Part 1: Database Setup\n",
    "\n",
    "## Overview\n",
    "\n",
    "In Part 1, you cleaned 7 messy CSV files using R. Now you will:- `clean_warranty_info.csv`\n",
    "\n",
    "1. Create a normalized PostgreSQL database with 10 tables- `clean_financing_details.csv`\n",
    "\n",
    "2. Load cleaned data using PostgreSQL COPY and INSERT commands- `clean_service_records.csv`\n",
    "\n",
    "3. Perform complex SQL queries for business analysis- `clean_salesperson_info.csv`\n",
    "\n",
    "- `clean_vehicle_inventory.csv`\n",
    "\n",
    "## Cleaned Files from Part 1:- `clean_customer_data.csv`\n",
    "- `clean_dealership_sales.csv`"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d7077f01",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "import subprocess\n",
    "from sqlalchemy import create_engine, text\n",
    "import os\n",
    "\n",
    "DB_NAME = 'dealership_final_db'\n",
    "DB_USER = 'student'\n",
    "DB_HOST = 'localhost'\n",
    "DB_PORT = '5432'\n",
    "DATA_PATH = '/workspaces/Fall2025-MS3083-Base_Template/data/'\n",
    "\n",
    "\n",
    "connection_string = f'postgresql://{DB_USER}@{DB_HOST}:{DB_PORT}/{DB_NAME}'print(f\"✓ Data path: {DATA_PATH}\")\n",
    "print(f\"✓ Connection parameters set: {DB_NAME}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4596e730",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Drop and create database\n",
    "subprocess.run(['dropdb', '--if-exists', DB_NAME, '-U', DB_USER], capture_output=True)\n",
    "result = subprocess.run(['createdb', DB_NAME, '-U', DB_USER], capture_output=True, text=True)\n",
    "\n",
    "if result.returncode == 0:\n",
    "    print(f\"✓ Database '{DB_NAME}' created\")\n",
    "    engine = create_engine(connection_string)\n",
    "    print(\"✓ Connection established\")\n",
    "else:\n",
    "    print(f\"Error: {result.stderr}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5ab3fd3b",
   "metadata": {},
   "source": [
    "## Part 2: Create Core Tables"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "595d5f8c",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create customers table\n",
    "create_customers = \"\"\"\n",
    "CREATE TABLE customers (\n",
    "    customer_id SERIAL PRIMARY KEY,\n",
    "    first_name VARCHAR(50) NOT NULL,\n",
    "    last_name VARCHAR(50) NOT NULL,\n",
    "    full_name VARCHAR(100),\n",
    "    email VARCHAR(100),\n",
    "    phone VARCHAR(20),\n",
    "    state VARCHAR(2),\n",
    "    zip_code VARCHAR(10),\n",
    "    registration_date DATE\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_customers))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ customers table created\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "07fbd73e",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create salespeople table\n",
    "create_salespeople = \"\"\"\n",
    "CREATE TABLE salespeople (\n",
    "    salesperson_id SERIAL PRIMARY KEY,\n",
    "    salesperson_name VARCHAR(100) NOT NULL,\n",
    "    hire_date DATE,\n",
    "    email VARCHAR(100),\n",
    "    phone VARCHAR(20),\n",
    "    commission_rate DECIMAL(4,3),\n",
    "    department VARCHAR(50),\n",
    "    status VARCHAR(20)\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_salespeople))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ salespeople table created\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6d2887dd",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create vehicles table\n",
    "create_vehicles = \"\"\"\n",
    "CREATE TABLE vehicles (\n",
    "    vehicle_id SERIAL PRIMARY KEY,\n",
    "    vin VARCHAR(17) UNIQUE NOT NULL,\n",
    "    make VARCHAR(50) NOT NULL,\n",
    "    model VARCHAR(50) NOT NULL,\n",
    "    year INTEGER NOT NULL,\n",
    "    color VARCHAR(30),\n",
    "    mileage INTEGER,\n",
    "    condition VARCHAR(20),\n",
    "    purchase_price DECIMAL(10,2),\n",
    "    lot_date DATE,\n",
    "    sold BOOLEAN DEFAULT FALSE\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_vehicles))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ vehicles table created\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fceb6cac",
   "metadata": {},
   "source": [
    "## Part 3: Create Lookup Tables"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1dd882fc",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create mechanics table\n",
    "create_mechanics = \"\"\"\n",
    "CREATE TABLE mechanics (\n",
    "    mechanic_id SERIAL PRIMARY KEY,\n",
    "    mechanic_name VARCHAR(100) UNIQUE NOT NULL\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_mechanics))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ mechanics table created\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2368b604",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create lenders table\n",
    "create_lenders = \"\"\"\n",
    "CREATE TABLE lenders (\n",
    "    lender_id SERIAL PRIMARY KEY,\n",
    "    lender_name VARCHAR(100) UNIQUE NOT NULL\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_lenders))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ lenders table created\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "aa412c58",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create warranty_providers table\n",
    "create_providers = \"\"\"\n",
    "CREATE TABLE warranty_providers (\n",
    "    provider_id SERIAL PRIMARY KEY,\n",
    "    provider_name VARCHAR(100) UNIQUE NOT NULL\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_providers))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ warranty_providers table created\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c6a98c6c",
   "metadata": {},
   "source": [
    "## Part 4: Create Transaction Tables with Foreign Keys"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "900f34d0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create sales table\n",
    "create_sales = \"\"\"\n",
    "CREATE TABLE sales (\n",
    "    sale_id SERIAL PRIMARY KEY,\n",
    "    sale_date DATE NOT NULL,\n",
    "    vehicle_id INTEGER REFERENCES vehicles(vehicle_id),\n",
    "    customer_id INTEGER REFERENCES customers(customer_id),\n",
    "    salesperson_id INTEGER REFERENCES salespeople(salesperson_id),\n",
    "    sale_price DECIMAL(10,2) NOT NULL,\n",
    "    trade_in_value DECIMAL(10,2) DEFAULT 0,\n",
    "    payment_method VARCHAR(20)\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_sales))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ sales table created with foreign keys\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e0be9e5b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create service_records table\n",
    "create_service = \"\"\"\n",
    "CREATE TABLE service_records (\n",
    "    service_id SERIAL PRIMARY KEY,\n",
    "    vehicle_id INTEGER REFERENCES vehicles(vehicle_id),\n",
    "    mechanic_id INTEGER REFERENCES mechanics(mechanic_id),\n",
    "    service_date DATE NOT NULL,\n",
    "    service_type VARCHAR(50),\n",
    "    labor_cost DECIMAL(8,2),\n",
    "    parts_cost DECIMAL(8,2),\n",
    "    notes TEXT\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_service))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ service_records table created with foreign keys\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a335a02a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create financing table\n",
    "create_financing = \"\"\"\n",
    "CREATE TABLE financing (\n",
    "    financing_id SERIAL PRIMARY KEY,\n",
    "    sale_id INTEGER REFERENCES sales(sale_id),\n",
    "    lender_id INTEGER REFERENCES lenders(lender_id),\n",
    "    loan_amount DECIMAL(10,2),\n",
    "    interest_rate DECIMAL(4,2),\n",
    "    term_months INTEGER,\n",
    "    monthly_payment DECIMAL(8,2),\n",
    "    approval_date DATE,\n",
    "    down_payment DECIMAL(10,2)\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_financing))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ financing table created with foreign keys\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e0b25008",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create warranties table\n",
    "create_warranties = \"\"\"\n",
    "CREATE TABLE warranties (\n",
    "    warranty_id SERIAL PRIMARY KEY,\n",
    "    vehicle_id INTEGER REFERENCES vehicles(vehicle_id),\n",
    "    provider_id INTEGER REFERENCES warranty_providers(provider_id),\n",
    "    warranty_type VARCHAR(50),\n",
    "    start_date DATE,\n",
    "    end_date DATE,\n",
    "    coverage_amount DECIMAL(10,2),\n",
    "    deductible DECIMAL(6,2),\n",
    "    status VARCHAR(20)\n",
    ");\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    conn.execute(text(create_warranties))\n",
    "    conn.commit()\n",
    "    \n",
    "print(\"✓ warranties table created with foreign keys\")\n",
    "print(\"\\n✓ All 10 tables created successfully!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "86c46409",
   "metadata": {},
   "source": [
    "## Part 5: Load Core Entity Data with PostgreSQL COPY\n",
    "\n",
    "We'll use PostgreSQL's native COPY command for efficient bulk loading of CSV data."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "42a3aebf",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load customers using PostgreSQL COPY command\n",
    "customers_file = os.path.join(DATA_PATH, 'clean_customer_data.csv')\n",
    "\n",
    "copy_command = f\"\"\"\\\\copy customers(customer_id, first_name, last_name, full_name, email, phone, state, zip_code, registration_date) \n",
    "\n",
    "FROM '{customers_file}'     print(f\"Error: {result.stderr}\")\n",
    "\n",
    "WITH (FORMAT CSV, HEADER TRUE);\"\"\"else:\n",
    "\n",
    "    print(f\"✓ Loaded {count} customers using COPY\")\n",
    "\n",
    "result = subprocess.run(        conn.commit()\n",
    "\n",
    "    ['psql', '-d', DB_NAME, '-U', DB_USER],        conn.execute(text(f\"SELECT setval('customers_customer_id_seq', {max_id});\"))\n",
    "\n",
    "    input=copy_command,        max_id = conn.execute(text(\"SELECT MAX(customer_id) FROM customers\")).scalar()\n",
    "\n",
    "    capture_output=True,        # Reset sequence\n",
    "\n",
    "    text=True        count = conn.execute(text(\"SELECT COUNT(*) FROM customers\")).scalar()\n",
    "\n",
    ")    with engine.connect() as conn:\n",
    "\n",
    "    # Get count\n",
    "if result.returncode == 0:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c8be2849",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load salespeople using PostgreSQL COPY command\n",
    "salespeople_file = os.path.join(DATA_PATH, 'clean_salesperson_info.csv')\n",
    "\n",
    "copy_command = f\"\"\"\\\\copy salespeople(salesperson_id, salesperson_name, hire_date, email, phone, commission_rate, department, status) \n",
    "FROM '{salespeople_file}' \n",
    "WITH (FORMAT CSV, HEADER TRUE);\"\"\"\n",
    "\n",
    "result = subprocess.run(\n",
    "    ['psql', '-d', DB_NAME, '-U', DB_USER],\n",
    "    input=copy_command,\n",
    "    capture_output=True,\n",
    "    text=True\n",
    ")\n",
    "\n",
    "if result.returncode == 0:\n",
    "    with engine.connect() as conn:\n",
    "        count = conn.execute(text(\"SELECT COUNT(*) FROM salespeople\")).scalar()\n",
    "        max_id = conn.execute(text(\"SELECT MAX(salesperson_id) FROM salespeople\")).scalar()\n",
    "        conn.execute(text(f\"SELECT setval('salespeople_salesperson_id_seq', {max_id});\"))\n",
    "        conn.commit()\n",
    "    print(f\"✓ Loaded {count} salespeople using COPY\")\n",
    "else:\n",
    "    print(f\"Error: {result.stderr}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "160e66e6",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load vehicles\n",
    "vehicles_df = pd.read_csv('/workspaces/Fall2025-MS3083-Base_Template/data/clean_vehicle_inventory.csv')\n",
    "vehicles_df.to_sql('vehicles', engine, if_exists='append', index=False)\n",
    "print(f\"✓ Loaded {len(vehicles_df)} vehicles\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7fa7e9ad",
   "metadata": {},
   "source": [
    "## Part 6: Load Lookup Tables"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e0690eb0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load mechanics (extract unique from service records)\n",
    "service_df = pd.read_csv('/workspaces/Fall2025-MS3083-Base_Template/data/clean_service_records.csv')\n",
    "mechanics_df = pd.DataFrame({'mechanic_name': service_df['mechanic_name'].unique()})\n",
    "mechanics_df.to_sql('mechanics', engine, if_exists='append', index=False)\n",
    "print(f\"✓ Loaded {len(mechanics_df)} mechanics\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "09b464bc",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load lenders (extract unique from financing)\n",
    "financing_df = pd.read_csv('/workspaces/Fall2025-MS3083-Base_Template/data/clean_financing_details.csv')\n",
    "lenders_df = pd.DataFrame({'lender_name': financing_df['lender_name'].unique()})\n",
    "lenders_df.to_sql('lenders', engine, if_exists='append', index=False)\n",
    "print(f\"✓ Loaded {len(lenders_df)} lenders\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6c8fc4f5",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load warranty providers\n",
    "warranty_df = pd.read_csv('/workspaces/Fall2025-MS3083-Base_Template/data/clean_warranty_info.csv')\n",
    "providers_df = pd.DataFrame({'provider_name': warranty_df['provider'].unique()})\n",
    "providers_df.to_sql('warranty_providers', engine, if_exists='append', index=False)\n",
    "print(f\"✓ Loaded {len(providers_df)} warranty providers\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5297b895",
   "metadata": {},
   "source": [
    "## Part 7: Load Sales Data with Foreign Key Mapping"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "17a5c8ea",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load sales with FK mapping\n",
    "sales_raw = pd.read_csv('/workspaces/Fall2025-MS3083-Base_Template/data/clean_dealership_sales.csv')\n",
    "\n",
    "# Get ID mappings\n",
    "customers_map = pd.read_sql(\"SELECT customer_id, full_name FROM customers\", engine)\n",
    "vehicles_map = pd.read_sql(\"SELECT vehicle_id, make, model, year FROM vehicles\", engine)\n",
    "salespeople_map = pd.read_sql(\"SELECT salesperson_id, salesperson_name FROM salespeople\", engine)\n",
    "\n",
    "# Create matching keys\n",
    "vehicles_map['vehicle_key'] = vehicles_map['make'] + '_' + vehicles_map['model'] + '_' + vehicles_map['year'].astype(str)\n",
    "sales_raw['vehicle_key'] = sales_raw['vehicle_make'] + '_' + sales_raw['vehicle_model'] + '_' + sales_raw['year'].astype(str)\n",
    "\n",
    "# Merge to get IDs\n",
    "sales_with_ids = sales_raw.merge(\n",
    "    customers_map, left_on='customer_name', right_on='full_name', how='left'\n",
    ").merge(\n",
    "    vehicles_map[['vehicle_id', 'vehicle_key']], on='vehicle_key', how='left'\n",
    ").merge(\n",
    "    salespeople_map, left_on='salesperson', right_on='salesperson_name', how='left'\n",
    ")\n",
    "\n",
    "# Prepare sales data\n",
    "sales_final = sales_with_ids[[\n",
    "    'sale_date', 'vehicle_id', 'customer_id', 'salesperson_id',\n",
    "    'sale_price', 'trade_in_value', 'payment_method'\n",
    "]]\n",
    "\n",
    "sales_final.to_sql('sales', engine, if_exists='append', index=False)\n",
    "print(f\"✓ Loaded {len(sales_final)} sales transactions\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "afabbec5",
   "metadata": {},
   "source": [
    "## Part 8: Load Service Records with Foreign Keys"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "cd4dd8c9",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load service records with FK mapping\n",
    "vehicles_vin_map = pd.read_sql(\"SELECT vehicle_id, vin FROM vehicles\", engine)\n",
    "mechanics_map = pd.read_sql(\"SELECT mechanic_id, mechanic_name FROM mechanics\", engine)\n",
    "\n",
    "service_with_ids = service_df.merge(\n",
    "    vehicles_vin_map, on='vin', how='left'\n",
    ").merge(\n",
    "    mechanics_map, on='mechanic_name', how='left'\n",
    ")\n",
    "\n",
    "service_final = service_with_ids[[\n",
    "    'vehicle_id', 'mechanic_id', 'service_date', 'service_type',\n",
    "    'labor_cost', 'parts_cost', 'notes'\n",
    "]]\n",
    "\n",
    "service_final.to_sql('service_records', engine, if_exists='append', index=False)\n",
    "print(f\"✓ Loaded {len(service_final)} service records\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c78428b3",
   "metadata": {},
   "source": [
    "## Part 9: Load Financing with Foreign Keys"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c62bfea7",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load financing with FK mapping\n",
    "sales_id_map = pd.read_sql(\"SELECT sale_id FROM sales\", engine)\n",
    "sales_id_map['row_num'] = range(1, len(sales_id_map) + 1)\n",
    "lenders_map = pd.read_sql(\"SELECT lender_id, lender_name FROM lenders\", engine)\n",
    "\n",
    "financing_df['row_num'] = financing_df['sale_id']\n",
    "financing_with_ids = financing_df.merge(\n",
    "    sales_id_map, on='row_num', how='left'\n",
    ").merge(\n",
    "    lenders_map, on='lender_name', how='left'\n",
    ")\n",
    "\n",
    "financing_final = financing_with_ids[[\n",
    "    'sale_id', 'lender_id', 'loan_amount', 'interest_rate',\n",
    "    'term_months', 'monthly_payment', 'approval_date', 'down_payment'\n",
    "]]\n",
    "\n",
    "financing_final.to_sql('financing', engine, if_exists='append', index=False)\n",
    "print(f\"✓ Loaded {len(financing_final)} financing records\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ab1dfbc7",
   "metadata": {},
   "source": [
    "## Part 10: Load Warranties with Foreign Keys"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b586fadf",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load warranties with FK mapping\n",
    "providers_map = pd.read_sql(\"SELECT provider_id, provider_name FROM warranty_providers\", engine)\n",
    "\n",
    "warranty_with_ids = warranty_df.merge(\n",
    "    providers_map, left_on='provider', right_on='provider_name', how='left'\n",
    ")\n",
    "\n",
    "warranty_final = warranty_with_ids[[\n",
    "    'vehicle_id', 'provider_id', 'warranty_type', 'start_date',\n",
    "    'end_date', 'coverage_amount', 'deductible', 'status'\n",
    "]]\n",
    "\n",
    "warranty_final.to_sql('warranties', engine, if_exists='append', index=False)\n",
    "print(f\"✓ Loaded {len(warranty_final)} warranties\")\n",
    "print(\"\\n✓ All data loaded successfully!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2b01f331",
   "metadata": {},
   "source": [
    "## Part 11: Basic SELECT Queries"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4b602564",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 11.1: List active salespeople\n",
    "query = \"\"\"\n",
    "SELECT salesperson_id, salesperson_name, hire_date, email, commission_rate\n",
    "FROM salespeople\n",
    "WHERE status = 'active'\n",
    "ORDER BY hire_date;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Active Salespeople:\")\n",
    "print(result)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "97ea30c9",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 11.2: List vehicles with active warranties\n",
    "query = \"\"\"\n",
    "SELECT v.make, v.model, v.year, w.warranty_type, w.end_date\n",
    "FROM vehicles v\n",
    "JOIN warranties w ON v.vehicle_id = w.vehicle_id\n",
    "WHERE w.status = 'active'\n",
    "ORDER BY w.end_date;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Vehicles with Active Warranties:\")\n",
    "print(result)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f3362522",
   "metadata": {},
   "source": [
    "## Part 12: Multi-Table JOINs"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b8c1c8c2",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 12.1: Complete sales information with financing\n",
    "query = \"\"\"\n",
    "SELECT \n",
    "    s.sale_id,\n",
    "    s.sale_date,\n",
    "    c.full_name AS customer,\n",
    "    v.make || ' ' || v.model AS vehicle,\n",
    "    sp.salesperson_name,\n",
    "    s.sale_price,\n",
    "    l.lender_name,\n",
    "    f.loan_amount,\n",
    "    f.interest_rate\n",
    "FROM sales s\n",
    "JOIN customers c ON s.customer_id = c.customer_id\n",
    "JOIN vehicles v ON s.vehicle_id = v.vehicle_id\n",
    "JOIN salespeople sp ON s.salesperson_id = sp.salesperson_id\n",
    "LEFT JOIN financing f ON s.sale_id = f.sale_id\n",
    "LEFT JOIN lenders l ON f.lender_id = l.lender_id\n",
    "ORDER BY s.sale_date DESC;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Complete Sales with Financing:\")\n",
    "print(result.head(10))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4c6c1b07",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 12.2: Vehicle service history\n",
    "query = \"\"\"\n",
    "SELECT \n",
    "    v.vin,\n",
    "    v.make,\n",
    "    v.model,\n",
    "    v.year,\n",
    "    sr.service_date,\n",
    "    sr.service_type,\n",
    "    m.mechanic_name,\n",
    "    sr.labor_cost + sr.parts_cost AS total_cost\n",
    "FROM vehicles v\n",
    "JOIN service_records sr ON v.vehicle_id = sr.vehicle_id\n",
    "JOIN mechanics m ON sr.mechanic_id = m.mechanic_id\n",
    "ORDER BY v.vin, sr.service_date;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Vehicle Service History:\")\n",
    "print(result.head(15))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "53575900",
   "metadata": {},
   "source": [
    "## Part 13: Aggregate Functions and GROUP BY"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "976dc265",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 13.1: Salesperson performance with commission\n",
    "query = \"\"\"\n",
    "SELECT \n",
    "    sp.salesperson_name,\n",
    "    COUNT(s.sale_id) AS total_sales,\n",
    "    SUM(s.sale_price) AS total_revenue,\n",
    "    AVG(s.sale_price) AS avg_sale,\n",
    "    SUM(s.sale_price * sp.commission_rate) AS total_commission\n",
    "FROM salespeople sp\n",
    "JOIN sales s ON sp.salesperson_id = s.salesperson_id\n",
    "WHERE sp.status = 'active'\n",
    "GROUP BY sp.salesperson_name, sp.commission_rate\n",
    "ORDER BY total_revenue DESC;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Salesperson Performance with Commission:\")\n",
    "print(result)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f418bf27",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 13.2: Service costs by mechanic\n",
    "query = \"\"\"\n",
    "SELECT \n",
    "    m.mechanic_name,\n",
    "    COUNT(sr.service_id) AS service_count,\n",
    "    SUM(sr.labor_cost) AS total_labor,\n",
    "    SUM(sr.parts_cost) AS total_parts,\n",
    "    SUM(sr.labor_cost + sr.parts_cost) AS total_revenue,\n",
    "    AVG(sr.labor_cost + sr.parts_cost) AS avg_service_cost\n",
    "FROM mechanics m\n",
    "JOIN service_records sr ON m.mechanic_id = sr.mechanic_id\n",
    "GROUP BY m.mechanic_name\n",
    "ORDER BY total_revenue DESC;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Service Revenue by Mechanic:\")\n",
    "print(result)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6a598301",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 13.3: Financing by lender\n",
    "query = \"\"\"\n",
    "SELECT \n",
    "    l.lender_name,\n",
    "    COUNT(f.financing_id) AS loan_count,\n",
    "    SUM(f.loan_amount) AS total_financed,\n",
    "    AVG(f.interest_rate) AS avg_rate,\n",
    "    AVG(f.term_months) AS avg_term\n",
    "FROM lenders l\n",
    "JOIN financing f ON l.lender_id = f.lender_id\n",
    "GROUP BY l.lender_name\n",
    "ORDER BY total_financed DESC;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Financing by Lender:\")\n",
    "print(result)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c4342d3e",
   "metadata": {},
   "source": [
    "## Part 14: Advanced Queries with CTEs and Subqueries"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "eea135cd",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 14.1: Top performing salespeople (above average)\n",
    "query = \"\"\"\n",
    "WITH sales_stats AS (\n",
    "    SELECT \n",
    "        salesperson_id,\n",
    "        COUNT(*) AS sale_count,\n",
    "        SUM(sale_price) AS total_revenue\n",
    "    FROM sales\n",
    "    GROUP BY salesperson_id\n",
    "),\n",
    "avg_performance AS (\n",
    "    SELECT AVG(total_revenue) AS avg_revenue\n",
    "    FROM sales_stats\n",
    ")\n",
    "SELECT \n",
    "    sp.salesperson_name,\n",
    "    ss.sale_count,\n",
    "    ss.total_revenue,\n",
    "    ap.avg_revenue,\n",
    "    ss.total_revenue - ap.avg_revenue AS above_average\n",
    "FROM salespeople sp\n",
    "JOIN sales_stats ss ON sp.salesperson_id = ss.salesperson_id\n",
    "CROSS JOIN avg_performance ap\n",
    "WHERE ss.total_revenue > ap.avg_revenue\n",
    "ORDER BY ss.total_revenue DESC;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Top Performers (Above Average):\")\n",
    "print(result)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "25a61a69",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 14.2: Vehicles with high service costs\n",
    "query = \"\"\"\n",
    "WITH vehicle_service_costs AS (\n",
    "    SELECT \n",
    "        vehicle_id,\n",
    "        SUM(labor_cost + parts_cost) AS total_service_cost,\n",
    "        COUNT(*) AS service_count\n",
    "    FROM service_records\n",
    "    GROUP BY vehicle_id\n",
    ")\n",
    "SELECT \n",
    "    v.make,\n",
    "    v.model,\n",
    "    v.year,\n",
    "    vsc.service_count,\n",
    "    vsc.total_service_cost,\n",
    "    v.purchase_price,\n",
    "    ROUND((vsc.total_service_cost / v.purchase_price * 100), 2) AS cost_percentage\n",
    "FROM vehicles v\n",
    "JOIN vehicle_service_costs vsc ON v.vehicle_id = vsc.vehicle_id\n",
    "WHERE vsc.total_service_cost > 200\n",
    "ORDER BY vsc.total_service_cost DESC;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Vehicles with High Service Costs:\")\n",
    "print(result)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c5037a00",
   "metadata": {},
   "source": [
    "## Part 15: Window Functions"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "231d570b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 15.1: Ranking salespeople by monthly sales\n",
    "query = \"\"\"\n",
    "SELECT \n",
    "    DATE_TRUNC('month', s.sale_date) AS month,\n",
    "    sp.salesperson_name,\n",
    "    COUNT(*) AS sales_count,\n",
    "    SUM(s.sale_price) AS monthly_revenue,\n",
    "    RANK() OVER (PARTITION BY DATE_TRUNC('month', s.sale_date) \n",
    "                 ORDER BY SUM(s.sale_price) DESC) AS rank\n",
    "FROM sales s\n",
    "JOIN salespeople sp ON s.salesperson_id = sp.salesperson_id\n",
    "GROUP BY DATE_TRUNC('month', s.sale_date), sp.salesperson_name\n",
    "ORDER BY month, rank;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Monthly Sales Rankings:\")\n",
    "print(result.head(20))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1168c44f",
   "metadata": {},
   "source": [
    "## Part 16: UPDATE Operations"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "413e5fcd",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 16.1: Mark sold vehicles\n",
    "update_query = \"\"\"\n",
    "UPDATE vehicles\n",
    "SET sold = TRUE\n",
    "WHERE vehicle_id IN (SELECT DISTINCT vehicle_id FROM sales);\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    result = conn.execute(text(update_query))\n",
    "    conn.commit()\n",
    "    print(f\"✓ Updated {result.rowcount} vehicles to sold status\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8822c86c",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 16.2: Expire old warranties\n",
    "update_query = \"\"\"\n",
    "UPDATE warranties\n",
    "SET status = 'expired'\n",
    "WHERE end_date < CURRENT_DATE AND status = 'active';\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    result = conn.execute(text(update_query))\n",
    "    conn.commit()\n",
    "    print(f\"✓ Updated {result.rowcount} warranties to expired status\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7e3b1882",
   "metadata": {},
   "source": [
    "## Part 17: INSERT Operations"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "26f8c585",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 17.1: Add new lender\n",
    "insert_query = \"\"\"\n",
    "INSERT INTO lenders (lender_name)\n",
    "VALUES ('Community Bank & Trust')\n",
    "RETURNING lender_id, lender_name;\n",
    "\"\"\"\n",
    "\n",
    "with engine.connect() as conn:\n",
    "    result = conn.execute(text(insert_query))\n",
    "    new_lender = result.fetchone()\n",
    "    conn.commit()\n",
    "    print(f\"✓ Added lender: {new_lender[1]} (ID: {new_lender[0]})\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "da8a6e99",
   "metadata": {},
   "source": [
    "## Part 18: Comprehensive Business Analytics"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "36399199",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 18.1: Complete dealership performance report\n",
    "query = \"\"\"\n",
    "SELECT \n",
    "    'Sales' AS category,\n",
    "    COUNT(DISTINCT sale_id)::TEXT AS metric_value,\n",
    "    'Total Transactions' AS metric_name\n",
    "FROM sales\n",
    "UNION ALL\n",
    "SELECT 'Sales', TO_CHAR(SUM(sale_price), 'FM$999,999,999.00'), 'Total Revenue' FROM sales\n",
    "UNION ALL\n",
    "SELECT 'Service', COUNT(*)::TEXT, 'Total Services' FROM service_records\n",
    "UNION ALL\n",
    "SELECT 'Service', TO_CHAR(SUM(labor_cost + parts_cost), 'FM$999,999,999.00'), 'Service Revenue' FROM service_records\n",
    "UNION ALL\n",
    "SELECT 'Financing', COUNT(*)::TEXT, 'Total Loans' FROM financing\n",
    "UNION ALL\n",
    "SELECT 'Financing', TO_CHAR(SUM(loan_amount), 'FM$999,999,999.00'), 'Amount Financed' FROM financing\n",
    "UNION ALL\n",
    "SELECT 'Inventory', COUNT(*)::TEXT, 'Total Vehicles' FROM vehicles\n",
    "UNION ALL\n",
    "SELECT 'Inventory', COUNT(*)::TEXT || ' available', 'Available Vehicles' FROM vehicles WHERE sold = FALSE;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"=\"*80)\n",
    "print(\"DEALERSHIP PERFORMANCE REPORT\")\n",
    "print(\"=\"*80)\n",
    "print(result)\n",
    "print(\"=\"*80)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "03fc9d71",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Exercise 18.2: Customer lifetime value analysis\n",
    "query = \"\"\"\n",
    "WITH customer_purchases AS (\n",
    "    SELECT \n",
    "        c.customer_id,\n",
    "        c.full_name,\n",
    "        COUNT(s.sale_id) AS purchase_count,\n",
    "        SUM(s.sale_price) AS total_spent\n",
    "    FROM customers c\n",
    "    LEFT JOIN sales s ON c.customer_id = s.customer_id\n",
    "    GROUP BY c.customer_id, c.full_name\n",
    ")\n",
    "SELECT \n",
    "    full_name,\n",
    "    purchase_count,\n",
    "    total_spent,\n",
    "    CASE \n",
    "        WHEN total_spent > 50000 THEN 'Premium'\n",
    "        WHEN total_spent > 30000 THEN 'High Value'\n",
    "        WHEN total_spent > 0 THEN 'Standard'\n",
    "        ELSE 'No Purchases'\n",
    "    END AS customer_tier\n",
    "FROM customer_purchases\n",
    "WHERE purchase_count > 0\n",
    "ORDER BY total_spent DESC;\n",
    "\"\"\"\n",
    "\n",
    "result = pd.read_sql(query, engine)\n",
    "print(\"Customer Lifetime Value:\")\n",
    "print(result)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6cca7cbd",
   "metadata": {},
   "source": [
    "## Summary\n",
    "\n",
    "**Congratulations! You've completed the comprehensive final project.**\n",
    "\n",
    "### ✓ Part 1 (R) - Data Cleaning:\n",
    "- Cleaned 7 messy CSV files with 100+ total records\n",
    "- Applied text standardization, date parsing, missing value handling\n",
    "- Calculated missing values using formulas\n",
    "\n",
    "### ✓ Part 2 (PostgreSQL) - Database Operations:\n",
    "- Created 10-table normalized database schema\n",
    "- Implemented primary and foreign key relationships\n",
    "- Loaded all cleaned data with proper FK mapping\n",
    "- Performed 18+ advanced SQL exercises:\n",
    "  - Multi-table JOINs (4-5 tables)\n",
    "  - Aggregate functions with GROUP BY\n",
    "  - CTEs and subqueries\n",
    "  - Window functions and rankings\n",
    "  - UPDATE and INSERT operations\n",
    "  - Comprehensive business analytics\n",
    "\n",
    "### Skills Mastered:\n",
    "- Data quality assessment and cleaning (R)\n",
    "- Complex database design and normalization\n",
    "- Foreign key relationships and referential integrity\n",
    "- Advanced SQL query techniques\n",
    "- Business intelligence and reporting\n",
    "- End-to-end data workflow from messy CSVs to actionable insights\n",
    "\n",
    "**This project demonstrates professional-level data engineering and analysis skills!**"
   ]
  }
 ],
 "metadata": {
  "language_info": {
   "name": "python"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
